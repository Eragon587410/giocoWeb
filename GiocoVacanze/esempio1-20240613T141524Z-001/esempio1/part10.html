<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
            background-color: black;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var Level1scene = {
    preload: preload,
    create: create,
    update: update

}
var Menu = {
    preload: preloadMenu,
    create: createMenu,
    update: updateMenu
}

var Logo = {
    preload: preloadLogo,
    create: createLogo
}

function preloadLogo(){
    this.load.image('logo', 'assets/logo.png');
    this.load.image('logoBello', 'assets/cazzari2.png');

}
function createLogo() {
        // Imposta lo sfondo nero
    this.cameras.main.setBackgroundColor('#000000');

        // Aggiungi il logo al centro dello schermo
    this.logoBello = this.add.image(this.cameras.main.width / 2, this.cameras.main.height / 2, 'logoBello');
    this.logoBello.setOrigin(0.5, 0.5);
    this.logoBello.alpha = 0;
    this.logo = this.add.image(this.cameras.main.width / 2, this.cameras.main.height / 2, 'logo');
    this.logo.setOrigin(0.5, 0.5);
    this.logo.alpha = 0;
    var blinkingText = this.add.text(600, 500, 'Premi ENTER per iniziare', {
            fontSize: '32px',
            fill: '#fff'
        }).setOrigin(0.5, 0.5);
    blinkingText.alpha = 0;
    this.time.delayedCall(1000, () => {
        this.tweens.add({
            targets: this.logoBello,
            alpha: { from: 0, to: 1 }, // Da completamente visibile a metà visibile
            duration: 3000,
            hold: 1000,  
            yoyo: true,
            repeat: 0
        });
    });
    this.time.delayedCall(8500, () => {
        this.tweens.add({
            targets: this.logo,
            alpha: { from: 0, to: 1 }, // Da completamente visibile a metà visibile
            duration: 3000,
            yoyo: false,
            repeat: 0
        });
        
    })
    this.time.delayedCall(9500, () => {
        this.tweens.add({
            targets: blinkingText,
            alpha: { from: 0, to: 1 }, // Partendo da opacità 1 a 0
            duration: 1000, // Durata della transizione
            yoyo: true, // Torna indietro dopo aver raggiunto 0
            repeat: -1, // Ripete all'infinito
            ease: 'Sine.easeInOut' // Easing per un effetto morbido
        });
        this.input.keyboard.on('keydown', function(event) {
        // Controlla se è stato premuto il tasto Invio (Enter)
            if (event.key === "Enter" || event.keyCode === 13) {
                blinkingText.setText("");
                startGame(this); // Chiamata alla funzione startGame
            }
        }, this);
    });
        // Aggiungi un listener per il tasto di input
        
}
function startGame(scene) {
        // Anima il logo, riducendo le dimensioni e spostandolo in alto
        scene.tweens.add({
            targets: scene.logo,
            x: scene.cameras.main.width / 2,
            y: 120,
            scale: 0.65,
            duration: 1000,
            ease: 'Power2',
            onComplete: () => {
                // Passa alla scena del menu
                scene.scene.start('Menu');
            }
        });
    }

function preloadMenu(){
    this.load.image('logo', 'assets/logo.png');
    this.load.image('bottone', 'assets/play.png');
}
function createMenu(){
    var scene = this;
    this.cameras.main.setBackgroundColor('#000000'); // Marrone
    var icone = this.physics.add.staticGroup();
    icone.create(600, 120, 'logo').setScale(0.65);
    //var button = this.add.image(600, 250, 'bottone').setScale(1).setInteractive();
    var menuIniziale = this.physics.add.staticGroup();
    var returnsButton = this.physics.add.staticGroup();
    var menuOpzioni = this.physics.add.staticGroup();
    var startButton = this.add.text(600, 300, 'PLAY', { fontSize: '50px', fontStyle: 'bold', fill: '#fff' }).setOrigin(0.5, 0.5).setInteractive();4
    var optionButton = this.add.text(600, 350, 'OPZIONI', { fontSize: '50px', fontStyle: 'bold', fill: '#fff' }).setOrigin(0.5, 0.5).setInteractive();
    startButton.alpha = 0.7;
    optionButton.alpha = 0.7;
    menuIniziale.add(startButton);
    menuIniziale.add(optionButton);
    /*this.tweens.add({
        targets: startButton,
        alpha: { from: 1, to: 0.5 }, // Da completamente visibile a metà visibile
        duration: 500,
        yoyo: true,
        repeat: -1
    });*/

    // Aggiungi l'evento per avviare la scena
    menuIniziale.children.iterate(function (child) {
        child.on('pointerover', function() {
            //startButton.setScale(1.5);
            scene.tweens.add({
                targets: child,
                alpha: { from: 0.7, to: 1 }, // Da completamente visibile a metà visibile
                scale: 1.2,
                duration: 400,
                yoyo: false,
                repeat: 0
            });
        });
        child.on('pointerout', function() {
            scene.tweens.add({
                targets: child,
                alpha: { from: 1, to: 0.7 }, // Da completamente visibile a metà visibile
                scale: 1,
                duration: 400,
                yoyo: false,
                repeat: 0
            });
        
        });
    });
        
    startButton.on('pointerdown', function() {
            console.log("ciao");
            scene.tweens.add({
                targets: startButton,
         // Da completamente visibile a metà visibile
                scale: 1,
                duration: 200,
                yoyo: true,
                repeat: 0,
                onComplete: () => {
                // Passa alla scena del menu
                scene.scene.start('level1');
                }
            });

    });
    optionButton.on('pointerdown', function() {
            console.log("ciao");
            scene.tweens.add({
                targets: optionButton,
                scale: 1,
                duration: 200,
                yoyo: true,
                repeat: 0,
                onComplete: () => {
                    startButton.destroy();
                    optionButton.destroy();
                    var optionTitle = scene.add.text(600, 350, 'OPZIONI', { fontSize: '50px', fontStyle: 'bold', fill: '#fff' }).setOrigin(0.5, 0.5).setScale(1.2);
                    scene.tweens.add({
                        targets: optionTitle, // Da completamente visibile a metà visibile
                        duration: 250,
                        y: 250,
                        yoyo: false,
                        repeat: 0
                    });
                    var returnButton = scene.add.text(600, 550, 'INDIETRO', { fontSize: '50px', fontStyle: 'bold', fill: '#fff' }).setOrigin(0.5, 0.5).setInteractive();
                    returnButton.alpha = 0.7;
                    returnButton.on('pointerover', function() {
                        scene.tweens.add({
                            targets: returnButton,
                            alpha: { from: 0.7, to: 1 }, // Da completamente visibile a metà visibile
                            scale: 1.2,
                            duration: 400,
                            yoyo: false,
                            repeat: 0
                        });  
                    }); 
                    returnButton.on('pointerdown', function() {
                        console.log("ciao");
                        scene.tweens.add({
                            targets: returnButton, // Da completamente visibile a metà visibile
                            scale: 1,
                            duration: 200,
                            yoyo: true,
                            repeat: 0,
                            onComplete: () => {
                                scene.tweens.add({
                                    targets: returnButton,
                                    alpha: { from: 1, to: 0 }, // Da completamente visibile a metà visibile
                                    duration: 200,
                                    yoyo: false,
                                    repeat: 0
                                    
                                });  
                            }
                        });  
                        
                    });
                }
            });
            
        });
            //menuIniziale.add(audioButton);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            


}

function updateMenu(){
}


var config = {
    type: Phaser.AUTO,
    width: 1200,
    height: 600,
    scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH
    },
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    },
};
var tocca;
var audio;
var nemicoMorto = false;
var portataMinima = 200;
var portataMassima = 350;
var livello = 1;
var numeroTotaleNemici = 2;
var numeroNemiciRimanenti = numeroTotaleNemici;
//var nemicoColpito = false;
var isFiringEnemy = false;
var proiettilePartito = false;
var ascensoreX;
var isMelee = false;
var isMeleeDamage = false;
var morte = false;
var player;
var stars;
var rKey;
var bombs;
var granate = 12;
var granata;
var shields;
var proiettili;
var ascensori;
var platforms;
var drone;
var cursors;
var enemies;
var isGranatingGo = false;
var score = 0;
var scene;
var gameOver = false;
var scoreText;
var ammoText;
var lives = 3;
var fireRate = 500;
var porte;
var porta;
var ultimoSparo = -fireRate;
var ultimoSparo_enemy = -fireRate;
var isFiring = false;
var posizione = false;
var isGranating = false;
var isGranatingGo = false;;
var ascensore;
var fermi;
var fermo;
var atterrato = false;
var collisione = false;
var shiftKey;
var ammo;
var isReloading = false;
var gKey;
var enemy;
var enemyTriggered = false;

var game = new Phaser.Game(config);
game.scene.add("Menu", Menu);
game.scene.add("level1", Level1scene);
game.scene.add("Logo", Logo);
game.scene.start("Logo");

function preload ()
{
    this.load.spritesheet('medKit', 'assets/medkit.png', {frameWidth: 256, frameHeight: 256});
    this.load.spritesheet('drone', 'assets/drone.png', {frameWidth: 480, frameHeight: 480});
    this.load.image('sky', 'assets/sky.png');
    this.load.spritesheet('grenade', 'assets/explosion.png', {frameWidth: 128, frameHeight: 128});
    this.load.image('game', 'assets/game.png');
    this.load.image('ground', 'assets/platform.png');
    this.load.image('star', 'assets/star.png');
    this.load.image('bomb', 'assets/bomb.png');
    this.load.image('shield', 'assets/live.png');
    this.load.image('proiettile', 'assets/proiettile.png');
    this.load.spritesheet('dude', 'assets/cazzone.png', { frameWidth: 128, frameHeight: 128 });
    this.load.spritesheet('enemy', 'assets/cazzone.png', { frameWidth: 128, frameHeight: 128 });
}

function create ()
{
    scene = this;
    //  A simple background for our game
    this.add.image(400, 300, 'sky');
    this.add.image(1200, 300, 'sky');
    
    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = this.physics.add.staticGroup();
    ascensori = this.physics.add.group();
    fermi = this.physics.add.staticGroup();

    
    //  Here we create the ground.
    //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
    platforms.create(400, 568, 'ground').setScale(2).refreshBody();
    platforms.create(1200, 568, 'ground').setScale(2).refreshBody();
    //platforms.create(800, 568, 'ground').setScale(2).refreshBody();
    //platforms.create(1000, 584, 'ground');
    //platforms.create(600, 284, 'ground');
    //platforms.create(200, 284, 'ground');

    ascensore = ascensori.create(1400, 500, 'ground');
    ascensore.setCollideWorldBounds(true);
    ascensore.body.setAllowGravity(false);
    //ascensore.setImmovable(true);
    ascensore.disableBody(true, true);
    ascensore.setTint(0xff0000);
    
    porte = this.physics.add.staticGroup();
    porta = porte.create(1192, 436, 'ground').setScale(0.5).setAngle(90).refreshBody();
    porta.setTint(0xff0000);
    porta.setSize(16, 200);
    porta.setOffset(-16, 0);

    ammo = 6;
    shiftKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SHIFT);
    rKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.R);
    gKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.G);
    fKey = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.F);

    boundsCollider = this.physics.add.sprite(0, 0, null);
    boundsCollider.setSize(this.physics.world.bounds.width, 1); // Imposta la larghezza uguale a quella del mondo
    boundsCollider.setOrigin(0, 0);
    var graphics = this.add.graphics();
    graphics.fillStyle(0xffffff); // Colore del triangolo (bianco)

    //  Now let's create some ledges
    //platforms.create(600, 400, 'ground');
    //platforms.create(50, 250, 'ground');
    //platforms.create(750, 220, 'ground');

    // The player and its settings
    player = this.physics.add.sprite(100, 400, 'dude');
    drone = this.physics.add.sprite(200, 480, 'drone');
    drone.body.setAllowGravity(false);
    drone.setScale(0.2);
    drone.refreshBody();
    enemies = this.physics.add.group();
    createEnemy(600, 400);
    createEnemy(500, 400);



    
    //enemies.add(enemy);
    //enemies.add(enemy2);

    //  Player physics properties. Give the little guy a slight bounce.
    player.setBounce(0);
    player.setCollideWorldBounds(true);
    player.setSize(40, 68);
    player.setOffset(40, 60);

    variabiliNemici();
    

    

    //  Our player animations, turning, walking left and walking right.
    this.anims.create({
        key: 'left',
        frames: this.anims.generateFrameNumbers('dude', { start: 7, end: 13 }),
        frameRate: 10,
        repeat: -1
    
    });

    this.anims.create({
        key: 'fire',
        frames: this.anims.generateFrameNumbers('dude', { start: 14, end: 17 }),
        frameRate: 10,
        repeat: -1
    
    });
    this.anims.create({
        key: 'drone_idle',
        frames: this.anims.generateFrameNumbers('drone', { start: 0, end: 7 }),
        frameRate: 10,
        repeat: -1
    
    });
    this.anims.create({
        key: 'drone_corsa',
        frames: this.anims.generateFrameNumbers('drone', { start: 8, end: 17 }),
        frameRate: 10,
        repeat: -1
    
    });
    this.anims.create({
        key: 'drone_esplodi',
        frames: this.anims.generateFrameNumbers('drone', { start: 18, end: 29 }),
        frameRate: 10,
        repeat: -1
    
    });
    this.anims.create({
        key: 'fire_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 14, end: 17 }),
        frameRate: 10,
        repeat: -1
    
    });

    this.anims.create({
        key: 'idle',
        frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 6 }),
        frameRate: 20,
        repeat: -1
    });
    this.anims.create({
        key: 'medKit_anim',
        frames: this.anims.generateFrameNumbers('medKit', { start: 0, end: 11 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'idle_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 0, end: 6 }),
        frameRate: 20,
        repeat: -1
    });
    this.anims.create({
        key: 'granate_anim',
        frames: this.anims.generateFrameNumbers('grenade', { start: 0, end: 8 }),
        frameRate: 9,
        repeat: -1
    });
    this.anims.create({
            key: 'stay',
            frames: [ { key: 'dude', frame: 24 } ],
            frameRate: 10
    });

    this.anims.create({
        key: 'right',
        frames: this.anims.generateFrameNumbers('dude', { start: 7, end: 13 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'melee',
        frames: this.anims.generateFrameNumbers('dude', { start: 58, end: 60 }),
        frameRate: 10,
        repeat: -1
    });

    this.anims.create({
        key: 'right_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 7, end: 13 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'run',
        frames: this.anims.generateFrameNumbers('dude', { start: 25, end: 32 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'run_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 25, end: 32 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'reload',
        frames: this.anims.generateFrameNumbers('dude', { start: 33, end: 45 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'grenade',
        frames: this.anims.generateFrameNumbers('dude', { start: 46, end: 54 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'colpito',
        frames: this.anims.generateFrameNumbers('dude', { start: 55, end: 57 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'colpito_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 55, end: 57 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'death',
        frames: this.anims.generateFrameNumbers('dude', { start: 18, end: 24 }),
        frameRate: 10,
        repeat: -1
    });
    this.anims.create({
        key: 'death_enemy',
        frames: this.anims.generateFrameNumbers('enemy', { start: 18, end: 24 }),
        frameRate: 10,
        repeat: -1
    });
    
    //  Input Events
    cursors = this.input.keyboard.createCursorKeys();

    //  Some stars to collect, 12 in total, evenly spaced 70 pixels apart along the x axis
    stars = this.physics.add.group({
        key: 'star',
        repeat: 11,
        setXY: { x: 12, y: 0, stepX: 70 }
    });

    stars.children.iterate(function (child) {

        //  Give each star a slightly different bounce
        //child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

    });

    bombs = this.physics.add.group();
    shields = this.physics.add.group();
    proiettili = this.physics.add.group();
    proiettili_enemy = this.physics.add.group();

    granata = this.physics.add.sprite(player.x+20, player.y-50, 'grenade');
    granata.setAllowGravity = true;
    granata.setCollideWorldBounds(true);
    granata.disableBody(true, true);

    var x = (player.x < 400) ? Phaser.Math.Between(0, 800) : Phaser.Math.Between(0, 400);

    var shield = this.physics.add.sprite(x, 16, 'medKit');
    shields.add(shield);
    shield.setScale(0.3);
    shield.anims.play('medKit_anim');

    
    //  The score
    //scoreText = this.add.text(19, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
    livesText = this.add.text(16, 16, 'Lives: '+ lives, { fontSize: '32px', fill: '#000' });
    ammoText = this.add.text(16, 60, 'Munizioni: ' + ammo, { fontSize: '32px', fill: '#000' });
    levelText = this.add.text(16, 104, 'Livello: ' + livello, { fontSize: '32px', fill: '#000' });

    this.physics.world.setBoundsCollision(true, true, true, true);
    
    //  Collide the player and the stars with the platforms
    this.physics.add.collider(player, platforms);
    this.physics.add.collider(enemies, ascensori);
    this.physics.add.collider(enemies, platforms);
    this.physics.add.collider(fermi,ascensori);
    this.physics.add.collider(stars, platforms);
    this.physics.add.collider(bombs, platforms);
    this.physics.add.collider(shields, platforms);
    this.physics.add.collider(proiettili, bombs);
    this.physics.add.collider(ascensori, platforms, setVariabile, null, this);
    this.physics.add.overlap(player, ascensori, ascensoreFunziona, null, this);
    this.physics.add.collider(proiettili, fermi);
    //this.physics.add.collider(proiettili, this.physics.world.bounds, collisionCallback, null, this);
    //this.physics.add.collider(proiettili_enemy, this.physics.world.bounds, collisionCallbackEnemy, null, this);
    this.physics.add.overlap(proiettili, enemies, dannoNemico, null, this);
    this.physics.add.overlap(player, proiettili_enemy, dannoPlayer, null, this);
    this.physics.add.overlap(player, enemies, contattoNemico, null, this);
    this.physics.add.overlap(player, drone, contattoDrone, null, this);
    this.physics.add.collider(player, porte, contattoPorta, null, this);

    
    ascensoreX = ascensore.x;

    //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
    this.physics.add.overlap(player, stars, collectStar, null, this);

    this.physics.add.collider(player, bombs, hitBomb, null, this);
    this.physics.add.collider(player, shields, collectLives, null, this);

    
}
function collisionCallback(proiettile){
    //proiettile.disableBody();
    //console.log("Il giocatore ha colpito il bordo della finestra!");
}
function collisionCallbackEnemy(proiettile_enemy){
    proiettile_enemy.disableBody();
    //console.log("Il giocatore ha colpito il bordo della finestra!");
    
}
function update ()
{
    var time = scene.time.now;
 
    if (!gameOver){
        if (!drone.nemicoMorto && !drone.nemicoColpito && !drone.inizioEsp){
            if (proiettilePartito && distanzaPlayerEnemyY(player, drone)<20){
                drone.enemyTriggered = true;
            }
            if ((drone.enemyTriggered || (distanzaPlayerEnemyY(player, drone)<50 && distanzaPlayerEnemyX(player, drone)<200 && ((player.x < drone.x && !drone.flipX) || (player.x > drone.x && drone.flipX))))){
                drone.enemyTriggered = true;
                drone.anims.play('drone_corsa', true);
                        if (drone.x > player.x){
                            drone.flipX = false;
                            drone.setVelocityX(-150);
                        } else {
                            drone.flipX = true;
                            drone.setVelocityX(150);
                        }
            }
        }
        enemies.children.iterate(function (enemy) {
            if (!enemy.nemicoMorto && !enemy.nemicoColpito){
                if (proiettilePartito && distanzaPlayerEnemyY(player, enemy)<20){
                    enemy.enemyTriggered = true;
                    
                }
                if ((enemy.enemyTriggered || (distanzaPlayerEnemyY(player, enemy)<20 && distanzaPlayerEnemyX(player, enemy)<200 && ((player.x < enemy.x && enemy.flipX) || (player.x > enemy.x && !enemy.flipX))))){
                    enemy.enemyTriggered = true;
                    if (!enemy.isFiringEnemy && (distanzaPlayerEnemy(player, enemy) > enemy.portata || ((enemy.x > player.x && !enemy.flipX) || (enemy.x < player.x && enemy.flipX)))){
                        enemy.anims.play('run_enemy', true);
                        if (enemy.x > player.x){
                            enemy.flipX = true;
                            enemy.setVelocityX(-150);
                        } else {
                            enemy.flipX = false;
                            enemy.setVelocityX(150);
                        }
                    } else if ((time - enemy.ultimoSparo_enemy) > fireRate && !enemy.isFiringEnemy && !enemy.nemicoColpito){
                        enemy.setVelocityX(0);
                        enemy.isFiringEnemy = true;
                        enemy.anims.play('fire_enemy', true);
                        enemy.ultimoSparo_enemy = time;
                        if (!enemy.nemicoColpito && !enemy.nemicoMorto){
                            scene.time.delayedCall(200, () => {
                                if (!enemy.nemicoColpito && !enemy.nemicoMorto){
                                    if (enemy.flipX){
                                        proiettile_enemy = proiettili_enemy.create(enemy.x-43, enemy.y+15, 'proiettile');
                                        proiettile_enemy.setScale(0.5);
                                        proiettile_enemy.setSize(9, 5);
                                        proiettile_enemy.setOffset(31, 17);
                                        proiettile_enemy.flipX = true;
                                        proiettile_enemy.setVelocityX(-1500);
                                    } else {
                                        var proiettile_enemy = proiettili_enemy.create(enemy.x+43, enemy.y+15, 'proiettile');
                                        proiettile_enemy.setScale(0.5);
                                        proiettile_enemy.setSize(9, 5);
                                        proiettile_enemy.setOffset(31, 17);
                                        proiettile_enemy.setVelocityX(1500);
                                    }
                                    proiettile_enemy.body.setAllowGravity(false);
                                    
                                    proiettile_enemy.setCollideWorldBounds(true);
                                    proiettile_enemy.body.onWorldBounds = true;
                                    scene.physics.world.on('worldbounds', function(body) {
                                        if (body.gameObject === proiettile_enemy) {
                                            proiettile_enemy.destroy();
                                        }
                                    }, this);
                                }  
                            });
                        }
                        scene.time.delayedCall(enemy.anims.currentAnim.duration, () => {
                            enemy.isFiringEnemy = false;
                        });     
                    } else if (!enemy.isFiringEnemy){
                        enemy.setVelocityX(0);
                        enemy.anims.play('idle_enemy', true);
                    }
                } else {
                    enemy.anims.play('right_enemy', true);
                    if (!enemy.flipX){
                        enemy.setVelocityX(100);
                        if (enemy.body.x >= enemy.enemy_spawn + 200){
                            enemy.anims.play('idle_enemy', true);
                            enemy.setVelocityX(0);
                            scene.time.delayedCall(1000, () => {
                                enemy.flipX = true;
                            });
                        }
                    } else {
                        enemy.setVelocityX(-100);
                        if (enemy.x <= enemy.enemy_spawn -200){
                            enemy.anims.play('idle_enemy', true);
                            enemy.setVelocityX(0);
                            scene.time.delayedCall(1000, () => {
                                enemy.flipX = false;
                            });
                        }
                    }
                }
            }
        });
        /*if (ascensore.body.touching.left || ascensore.body.touching.right){
            //ascensore.x = ascensoreX;
            //ascensore.setVelocityX(0);
        }*/
        
        if (collisione && !ascensore.body.touching.up){
            collisione = false;
        }
        if (collisione && atterrato){
            //ascensore.setVelocityX(0);
            ascensore.setVelocityY(-100);
            player.y = ascensore.y -80;
            player.setVelocityY(0);
            //collisione = false;
            this.time.delayedCall(2690, () => {
                ascensore.setVelocityY(0);
                this.time.delayedCall(1000, () => {
                    atterrato = false;
                });
            });
        } else if (!atterrato){
            //ascensore.setVelocityX(0);
            ascensore.setVelocityY(100);
            if (collisione){
                player.y = ascensore.y -80;
                player.setVelocityY(ascensore.body.velocity.y);
                //player.setVelocityY(0);
            } else if (ascensore.contatto && ascensore.body.touching.up){
                player.y = ascensore.y -80;
            } else {
                ascensore.contatto = false;
            }
            
            
            //collisione = false;
        }
        if (!player.colpito){
            if (ammo < 6 && rKey.isDown & player.body.touching.down){
                player.setVelocityX(0);
                player.anims.play('reload', true);
                isReloading = true;
                this.time.delayedCall(player.anims.currentAnim.duration, () => {
                    ammo = 6;
                    ammoText.setText('Munizioni: ' + ammo);
                    isReloading = false;
                });
            } else if (!isReloading && !isGranating && !isMelee){
                if (fKey.isDown){
                    isMelee = true;
                    player.setVelocityX(0)
                    player.anims.play('melee', true);
                    this.time.delayedCall(player.anims.currentAnim.duration, () => {
                        isMelee = false;
                        isMeleeDamage = false;
                    });
                    this.time.delayedCall(100, () => {
                        isMeleeDamage = true;
                    });
                }
                else if (gKey.isDown && granate > 0  && !isGranatingGo){
                    isGranating = true;
                    isGranatingGo = true;

                    player.setVelocityX(0);
                    player.anims.play('grenade', true);
                    
                    this.time.delayedCall(player.anims.currentAnim.duration, () => {
                        granata.enableBody(true, player.x+20, player.y-50, true, true);
                        if (player.flipX){
                            granata.setVelocity(-500,-50);
                        } else {
                            granata.setVelocity(500,-50);
                        }
                        granata.anims.play('granate_anim', true);
                        this.time.delayedCall(450, () => {

                            granata.setVelocity(0, 0);
                            
                        });
                        this.time.delayedCall(granata.anims.currentAnim.duration, () => {
                            granata.disableBody(true, true);
                            granata.anims.stop();
                            isGranatingGo = false;
                        });
                        isGranating = false;
                    });
                    granate--;
                } else if (!isGranating){
                
                    if (!player.colpito && cursors.space.isDown && (time - ultimoSparo) > fireRate && ammo > 0 && player.body.touching.down){
                        player.setVelocityX(0);
                        player.anims.play('fire', true);
                        ultimoSparo = time;
                        isFiring = true;
                        if (!player.colpito){
                            this.time.delayedCall(200, () => {
                                if (!player.colpito){
                                    proiettilePartito = true;
                                    if (player.flipX){
                                        var proiettile = proiettili.create(player.x-43, player.y+15, 'proiettile');
                                        proiettile.setScale(0.5);
                                        proiettile.setSize(9, 5);
                                        proiettile.setOffset(31, 17);
                                        proiettile.flipX = true;
                                        proiettile.setVelocityX(-1500);
                                    } else {
                                        var proiettile = proiettili.create(player.x+43, player.y+15, 'proiettile');
                                        proiettile.setScale(0.5);
                                        proiettile.setSize(9, 5);
                                        proiettile.setOffset(31, 17);
                                        proiettile.setVelocityX(1500);
                                    }
                                    proiettile.body.setAllowGravity(false);
                                    
                                    proiettile.setCollideWorldBounds(true);
                                    ammo--;
                                    ammoText.setText('Munizioni: ' + ammo);
                                    /*if (nemicoColpito){
                                        proiettile.disableBody(true, true);
                                    }*/
                                    proiettile.body.onWorldBounds = true;
                                    
                                    this.physics.world.on('worldbounds', function(body) {
                                        if (body.gameObject === proiettile) {
                                            proiettile.destroy();
                                        }
                                    }, this);
                                }
                            });
                        
                            this.time.delayedCall(player.anims.currentAnim.duration, () => {
                                isFiring = false; 
                                proiettilePartito = false;
                            });
                        }       
                    } else if (!isFiring && !isReloading && !isGranating){
                        if (cursors.left.isDown && !(player.body.velocity.x > 0))
                        {
                            if (shiftKey.isDown){
                                player.anims.play('run', true);
                                player.setVelocityX(-250);
                            } else {
                                player.setVelocityX(-160);

                                player.anims.play('left', true);    
                            }
                            player.flipX = true;
                        }
                        else if (cursors.right.isDown)
                        {
                            if (shiftKey.isDown){
                                player.anims.play('run', true);
                                player.setVelocityX(250);
                            } else {
                                player.setVelocityX(160);

                                player.anims.play('right', true);
                            }
                            player.flipX = false;
                        }
                        else
                        {
                            player.setVelocityX(0);

                            player.anims.play('idle', true);
                        }

                        if (cursors.up.isDown && player.body.touching.down)
                        {
                            player.setVelocityY(-330);
                        }
                    }
                }
            }
        }
    } 
}

function variabiliNemici(){
    enemies.children.iterate(function (enemy) {
        enemy.setBounce(0);
        enemy.setCollideWorldBounds(true);
        enemy.setSize(40, 68);
        enemy.setOffset(40, 60);
        enemy.ultimoSparo_enemy = -fireRate;
        enemy.enemy_spawn = enemy.x;
        enemy.range = Math.range
        enemy.portata = Math.random() * (portataMassima - portataMinima) + portataMinima;
        enemy.vita = 3;
    });
}
function dannoPlayer(player, proiettile_enemy){
    if (lives <= 1){
        //proiettile.destroy();
    playerDead();
    } else {
        player.setVelocityX(0);
        player.anims.play("colpito");
        scene.time.delayedCall(player.anims.currentAnim.duration, () => {
            player.colpito = false;
        });
    }
    player.colpito = true;
    proiettile_enemy.destroy();
    lives--;
    livesText.setText('Lives: ' + lives);
}
function playerDead(){
    gameOver = true;
    player.anims.play('death', true);
    player.setVelocityX(0);
    player.disableBody();
    scene.time.delayedCall(player.anims.currentAnim.duration, () => {
        platforms.create(400, 300, 'game');
        player.destroy();
        morte = true;
        scene.physics.pause();
        return;
    });     
}
function dannoNemico(proiettile, enemy) {
    if (!enemy.nemicoMorto){
        if (enemy.vita > 1){
            enemy.nemicoColpito = true;
            enemy.fermaProiettile = true;
            enemy.vita--;
            enemy.setVelocityX(0);
            proiettile.disableBody(true, true);
            enemy.anims.play('colpito_enemy');
            scene.time.delayedCall(enemy.anims.currentAnim.duration, () => {
                enemy.nemicoColpito = false;
            });
        } else {
            enemy.enemyTriggered = false;
            enemy.nemicoMorto = true;
            enemy.nemicoColpito = true;
            enemy.anims.play('death_enemy', true);
            enemy.setVelocityX(0);

            // Disabilita il proiettile
            proiettile.disableBody(true, true);

            // Disabilita il corpo del nemico dopo l'animazione della morte
            scene.time.delayedCall(enemy.anims.currentAnim.duration, () => {
                //enemy.disableBody(true, true);
                enemy.destroy();
                numeroNemiciRimanenti--;
            });
        }
    }
}
function setVariabile(){
    atterrato = true;
    
}
//function ascensoreResta(){
 //   ascensore.x = ascensoreX;
//}

function stop(ascensore, platform){
    ascensore.setVelocity(0);
}
function contattoPorta(){
    if (numeroNemiciRimanenti == 0){
        //livello++;
        //numeroTotaleNemici = livello * 2;
        //numeroNemiciRimanenti = numeroTotaleNemici;
        levelUp();
        
    }
}
function level2(){
    console.log(ciao);
}

function createEnemy(x, y){
    enemy = scene.physics.add.sprite(x, y, 'enemy');
    enemies.add(enemy);
}
function levelUp(){
    livello++;
    numeroTotaleNemici = livello * 2;
    numeroNemiciRimanenti = numeroTotaleNemici;
    //player.disableBody(true, true);
    //player = this.physics.add.sprite(100, 400, 'dude');
    player.enableBody(true, 100, 400, true, true);
    if (livello == 2){
        platforms.children.iterate(function (platform) {
            platform.disableBody(true, true);
        });
        platforms.create(600, 284, 'ground');
        platforms.create(200, 284, 'ground');
        platforms.create(400, 568, 'ground').setScale(2).refreshBody();
        platforms.create(1000, 584, 'ground');
        ascensore.enableBody(true, 1400, 500, true, true);
        porta.disableBody(true, true);
        porta = porte.create(8, 200, 'ground').setScale(0.5).setAngle(90).refreshBody();
        porta.setTint(0xff0000);
        porta.setSize(16, 200);
        porta.setOffset(-16, 0);
        createEnemy(600, 400);
        createEnemy(500, 400);
        createEnemy(400, 200);
        createEnemy(300, 200);
        variabiliNemici();
    }
}
function contattoDrone(player, drone){
    drone.inizioEsp = true;
    drone.anims.play('drone_esplodi', true);
    drone.setVelocityX(0);
    scene.time.delayedCall(900, () => {
        if (distanzaPlayerEnemyX(player, drone)<70){
            playerDead();
        }
    });
    scene.time.delayedCall(drone.anims.currentAnim.duration, () => {
        drone.destroy();
    })
}
function contattoNemico(player, enemy) {
    if (isMeleeDamage && !enemy.nemicoMorto) {
        if ((!player.flipX && player.x < enemy.x) || (player.flipX && player.x > enemy.x)) {
            enemy.enemyTriggered = false;
            enemy.nemicoMorto = true;
            enemy.anims.play('death_enemy', true);
            enemy.setVelocityX(0);

            // Disabilita il corpo del nemico dopo l'animazione della morte
            scene.time.delayedCall(enemy.anims.currentAnim.duration, () => {
                //enemy.disableBody(true, true);
                enemy.destroy();
                numeroNemiciRimanenti--;
            });
        }
    }
}


function distanzaPlayerEnemy(giocatore,  nemico){
    return Math.sqrt((giocatore.x - nemico.x)**2 + (giocatore.y - nemico.body.y) ** 2);
}
function distanzaPlayerEnemyX(giocatore,  nemico){
    return Math.abs(giocatore.x - nemico.x);
}
function distanzaPlayerEnemyY(giocatore,  nemico){
    return Math.abs(giocatore.y - nemico.y);
}
function ascensoreFunziona(player, ascensore){
    //ascensore.x = ascensoreX;
    var prova;
    if (!atterrato && ascensore.body.touching.down){
        playerDead();
    } else {
        var enPresenti = false;
        enemies.children.iterate(function (enemy) {
            if (distanzaPlayerEnemyY(ascensore, enemy)<100){
                enPresenti = true;
            }
        });
        if (!enPresenti){
            ascensore.contatto = false;
            collisione = true;
            if (prova != null){
                //scene.physics.world.removeCollider(prova);
            }
        } else {
            //prova = scene.physics.add.collider(player, ascensori, ascensoreFunziona);
            //ascensore.contatto = true;
            player.y = ascensore.y - 80;
        }
    }
    /*if (atterrato){
        ascensore.setVelocityY(-100);
        this.time.delayedCall(1500, () => {
            ascensore.setVelocityY(0);
            atterrato = false;
        });
    } else{
        ascensore.setVelocityY(100);
        this.time.delayedCall(1500, () => {
            ascensore.setVelocityY(0);
        });
    }*/
}
function collectStar (player, star)
{
    star.disableBody(true, true);
    

    //  Add and update the score
    score += 10;
    //scoreText.setText('Score: ' + score);

    if (stars.countActive(true) === 0)
    {
        //  A new batch of stars to collect
        stars.children.iterate(function (child) {

            child.enableBody(true, child.x, 0, true, true);

        });
        var xshield = (player.x < 400) ? Phaser.Math.Between(0, 800) : Phaser.Math.Between(0, 400);
        var shield = shields.create(xshield, 16, 'shield');
        shield.setBounce(0.1);
        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        var bomb = bombs.create(x, 16, 'bomb');
        bomb.setBounce(1);
        bomb.setCollideWorldBounds(true);
        bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb.allowGravity = false;

       

    }
}
function collectLives (player, shield)
{
    shield.disableBody(true, true);

    //  Add and update the score
    lives++;
    livesText.setText('Lives: ' + lives);
}

function hitBomb (player, bomb)
{
    lives = lives -10;
    if (lives>1){
        lives--;
        livesText.setText('lives: ' + lives);
        bomb.disableBody(true, true);

        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

        var bomb = bombs.create(x, 16, 'bomb');
        bomb.setBounce(1);
        bomb.setCollideWorldBounds(true);
        bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb.allowGravity = false;
    } else {
        lives--;
        livesText.setText('lives: ' + lives);
        this.physics.pause();

        //player.setTint(0xff0000);

        //player.anims.play('turn');

        gameOver = true;
    }
    
}

</script>

</body>
</html>